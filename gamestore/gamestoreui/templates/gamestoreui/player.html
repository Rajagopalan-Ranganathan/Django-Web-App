 {% extends "base.html" %} {% load staticfiles %} {% block title %}Online Game Store{% endblock %} {% block header %} {{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'gamestoreui/styles.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'gamestoreui/bootstrap.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'gamestoreui/portfolio-item.css' %}">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!--<script src="{% static 'gamestoreui/js/dashboard.js' %}"></script>-->

{% endblock %} {% block content %}
<div class="container">
    <div>
        <div class="col-md-6" >
            <!-- http://127.0.0.1:3000/jsgames/breakout/breakout.html-->
            <iframe src="{{ game_server }}" id="gameIframe"></iframe>
        </div>
        <div class="col-md-6">
            <h3>{{game.name}}</h3>
            <p>{{game.description}}</p>
            <div id="leaderboard">
              <div class="row">
                <div class="col-xs-8">Player</div>
                <div class="col-xs-4">Score</div>
              </div>
              {% for leader in leaders %}
              <div class="row">
                <div class="col-xs-8">{{leader.player}}</div>
                <div class="col-xs-4">{{leader.score}}</div>
              </div>
              {% endfor %}
            </div>
        </div>
    </div>
</div>
{% comment %}
      Modal used to display messages in the page
  {% endcomment %}
  <div id="modalInfo" class="modal fade" role="dialog">
      <div class="modal-dialog">
          <!-- Modal content-->
          <div class="modal-content">
              <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              </div>
              <div class="modal-body">
                  <form class="form-signin" id="detailInfo">
                  <h3 class="form-signin-heading" id="modalMessage">Title</h3>
                  </form>
              </div>
          </div>
      </div>
  </div>
<script type="text/javascript">
    window.addEventListener("message", receiveMessage, false);

    function receiveMessage(event) {
        if(event.data.messageType=="SAVE")
        {
          event.data.gameState = JSON.stringify(event.data.gameState)
          sendData(event.data, '#')
        }
        else if(event.data.messageType == "LOAD_REQUEST"){
                sendData(event.data,"#");
            }
        else if(event.data.messageType == "SETTING"){
                var width = parseInt(event.data.options.width);
                var height = parseInt(event.data.options.height);
                if(!isNaN(width)){
                    if(width>800){
                        width = 800;
                    }else if(width<20){
                        width = 20;
                    }
                    $('#gameIframe').css('width',width);
                }
                if(!isNaN(height)){
                    if(height>1000){
                        height = 1000;
                    }else if(height<20){
                        height = 20;
                    }
                    $('#gameIframe').css('height',height);
                }
            }
    }

    function sendData(data, url) {
        data.csrfmiddlewaretoken = "{{ csrf_token  }}";
        var message = {};
        $.ajax({
            method: 'POST',
            url: url,
            data: data,
            success: function(data) {
                if (data.error) {
                    message = {
                        messageType: "ERROR",
                        info: data.error
                    };
                    sendMessageToGame(message);
                } else {
                    if (data.result) {
                        message.messageType = "LOAD";
                        message.gameState = jQuery.parseJSON(data.result);
                        sendMessageToGame(message);
                        $('#score').text(message.score);
                    }
                }
            },
            error: function(data) {
                if (data.error) {
                    message = {
                        messageType: "ERROR",
                        info: data.error
                    };
                    sendMessageToGrame(message);
                }
            }
        });
    }

    {% comment %}
            Function that locate the iframe and send the messages to the game
            A pop up is shown if no iframe is found
        {% endcomment %}
        function sendMessageToGame(message){
            var iframe = document.getElementById('gameIframe');
            if(iframe){
                iframe.contentWindow.postMessage(message, "*");
            }else{
                $('#modalMessage').text("Ops, game not found!");
                $("#modalInfo").removeClass('info done');
                $("#modalInfo").addClass('error');
                $("#modalInfo").modal();
            }
        }
</script>
{% endblock %}
